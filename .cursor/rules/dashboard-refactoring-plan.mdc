# Dashboard Refactoring Plan

This rule documents how to refactor `bot/ui/dashboard.py` into a clean architecture.

## Current Issues (dashboard.py @ 1078 lines)

1. **Embedded CSS** (lines 45-189) - 145 lines of CSS as Python string
2. **Data classes mixed with UI** - `OpportunityCondition`, `PendingOpportunity` in UI file
3. **Business logic in UI** - Market analysis, momentum calculation, opportunity detection
4. **Magic numbers** - 0.10, 0.30, 0.5, -0.3, 60, 100, etc.
5. **Long methods** - `analyze_opportunity()`, `analyze_market_conditions()` 40+ lines each
6. **Single file doing everything** - WebSocket, analysis, UI, trading, history

## Target Structure

```
bot/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models.py           # OpportunityCondition, PendingOpportunity, etc.
â”‚   â”œâ”€â”€ config.py           # TradingConfig dataclass
â”‚   â””â”€â”€ analysis/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ momentum.py     # calculate_momentum, get_lookback_price
â”‚       â””â”€â”€ opportunities.py # OpportunityAnalyzer class
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ dashboard.py        # Main app (< 200 lines)
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â””â”€â”€ theme.css       # All CSS here
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ prices_panel.py
â”‚       â”œâ”€â”€ orderbook_panel.py
â”‚       â”œâ”€â”€ trades_panel.py
â”‚       â”œâ”€â”€ ai_panel.py
â”‚       â”œâ”€â”€ opportunities_panel.py
â”‚       â””â”€â”€ positions_panel.py
```

## Step-by-Step Refactoring

### Step 1: Extract CSS
Move CSS to `bot/ui/styles/theme.css`, update dashboard:
```python
class TradingDashboard(App):
    CSS_PATH = "styles/theme.css"
```

### Step 2: Extract Data Models
Move to `bot/core/models.py`:
- `OpportunityCondition`
- `PendingOpportunity`
- Any other dataclasses

### Step 3: Extract Configuration
Create `bot/core/config.py`:
```python
@dataclass
class TradingConfig:
    # Thresholds
    track_threshold: float = 0.10
    trade_threshold: float = 0.30
    take_profit_pct: float = 0.50
    stop_loss_pct: float = -0.30
    
    # Position sizing
    position_size_pct: float = 0.10
    
    # Analysis
    momentum_lookback_seconds: int = 60
    market_analysis_interval: int = 10
    price_history_maxlen: int = 500
    
    # Display
    max_trades_displayed: int = 15
    orderbook_depth: int = 8
```

### Step 4: Extract Momentum Calculation
Move to `bot/core/analysis/momentum.py`:
```python
def calculate_momentum(
    current_price: float,
    price_history: deque,
    lookback_seconds: int = 60,
) -> float | None:
    """Calculate price momentum over lookback period."""
    ...

def get_lookback_price(
    price_history: deque,
    lookback_seconds: int,
) -> tuple[float | None, float]:
    """Get price from N seconds ago and the actual age."""
    ...
```

### Step 5: Extract Opportunity Analysis
Move to `bot/core/analysis/opportunities.py`:
```python
class OpportunityAnalyzer:
    def __init__(self, config: TradingConfig):
        self.config = config
    
    def should_track(self, momentum_pct: float) -> bool:
        ...
    
    def should_trade(self, momentum_pct: float) -> bool:
        ...
    
    def create_opportunity(self, coin: str, direction: str, price: float) -> PendingOpportunity:
        ...
    
    def validate_conditions(self, opp: PendingOpportunity, ...) -> None:
        ...
```

### Step 6: Extract Market Analysis
Move to `bot/core/analysis/market.py`:
```python
class MarketAnalyzer:
    def analyze_conditions(self, price_history: dict, prices: dict) -> MarketCondition:
        ...
    
    def get_condition_description(self, avg_volatility: float) -> tuple[str, str, str]:
        """Returns (emoji_label, color, description)."""
        ...
```

### Step 7: Extract UI Components
Each panel becomes its own widget:

```python
# bot/ui/components/prices_panel.py
class PricesPanel(Static):
    def __init__(self, coins: list[str]):
        super().__init__()
        self.coins = coins
    
    def compose(self) -> ComposeResult:
        yield Static("ðŸ’° PRICES & MOMENTUM", classes="panel-title")
        yield RichLog(id="prices-log", highlight=True, markup=True)
    
    def update(self, prices: dict, prev_prices: dict, momentum: dict) -> None:
        ...
```

### Step 8: Slim Down Dashboard
Final `dashboard.py` should only contain:
- App initialization
- Layout composition (`compose()`)
- WebSocket connection setup
- Message routing to handlers
- Action handlers for keybindings
- Coordination between components

## Testing After Refactoring

1. **Unit tests** for `momentum.py`, `opportunities.py`, `market.py`
2. **Integration tests** for `OpportunityAnalyzer`
3. **UI tests** for individual components using Textual's test framework

## Migration Notes

- Keep the old dashboard.py as `dashboard_legacy.py` until new version is validated
- Refactor incrementally - one extraction at a time
- Run the dashboard after each extraction to verify functionality
